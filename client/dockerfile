# ------------ PROD

# Stage 1: Build
# Use a specific version instead of 'latest' to avoid "it broke overnight" syndrome
FROM node:22-alpine AS build
WORKDIR /app

COPY package*.json ./

# USE 'npm ci' instead of 'npm install'
# It's faster and ensures versions match your package-lock.json exactly
RUN npm ci

COPY . .
RUN npm run build --configuration=production

# Stage 2: Serve with Nginx
FROM nginx:alpine

# Security: Remove default nginx static assets
RUN rm -rf /usr/share/nginx/html/*

# Copy your built app
COPY --from=build /app/dist/client-0.2/browser /usr/share/nginx/html

# Copy custom config (Crucial for Angular/React routing)
COPY nginx.conf /etc/nginx/conf.d/default.conf

# Optional: Ensure permissions are correct for the nginx user
RUN touch /var/run/nginx.pid && \
    chown -R nginx:nginx /var/run/nginx.pid /usr/share/nginx/html /var/cache/nginx /var/log/nginx

USER nginx
EXPOSE 80

# ------------ DEV

# FROM node:latest

# WORKDIR /app

# COPY package*.json ./

# RUN npm install

# EXPOSE 4200

# # Starting ze app
# CMD ["npm", "start"]
# # CMD ["npx", "ng", "serve", "--host", "0.0.0.0", "--port", "4200"]
# # RUN npm start